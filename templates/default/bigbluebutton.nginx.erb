server {
     listen   80;
     server_name  <%= @domain %>;
     <% if @secure -%>
     listen 443 ssl;
     ssl_certificate /etc/nginx/ssl/<%= @certificate_file %>;
     ssl_certificate_key /etc/nginx/ssl/<%= @certificate_key_file %>;
     ssl_session_cache shared:SSL:10m;
     ssl_session_timeout 10m;
     # need TLSv1 for the Java calls for the API, otherwise it would be removed
     ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
     ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
     ssl_prefer_server_ciphers on;
     ssl_dhparam /etc/nginx/ssl/<%= @dhparam_file %>;
     ssl_ecdh_curve secp384r1; # Requires nginx >= 1.1.0
     # can't enable it because we still use nginx/1.4.6
     # ssl_session_tickets off; # Requires nginx >= 1.5.9
     ssl_stapling on; # Requires nginx >= 1.3.7
     ssl_stapling_verify on; # Requires nginx => 1.3.7
     # still unclear why we need to set the resolver
     # resolver $DNS-IP-1 $DNS-IP-2 valid=300s;
     # resolver_timeout 5s;
     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
     <% end -%>
     
     access_log  /var/log/nginx/bigbluebutton.access.log;
     
     location ~* \.(old|bak|tmp)$|/\. {
          deny all;
     }

     # Handle RTMPT (RTMP Tunneling).  Forwards requests
     # to Red5 on port 5080
     location ~ (/open/|/close/|/idle/|/send/|/fcs/) {
          proxy_pass         http://127.0.0.1:5080;
          proxy_redirect     off;
          proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
          
          client_max_body_size       10m;
          client_body_buffer_size    128k;
          
          proxy_connect_timeout      90;
          proxy_send_timeout         90;
          proxy_read_timeout         90;
          
          proxy_buffering            off;
          keepalive_requests         1000000000;
     }
     
     # Handle desktop sharing tunneling.  Forwards
     # requests to Red5 on port 5080.
     location /deskshare {
          proxy_pass         http://127.0.0.1:5080;
          proxy_redirect     default;
          proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
          client_max_body_size       10m;
          client_body_buffer_size    128k;
          proxy_connect_timeout      90;
          proxy_send_timeout         90;
          proxy_read_timeout         90;
          proxy_buffer_size          4k;
          proxy_buffers              4 32k;
          proxy_busy_buffers_size    64k;
          proxy_temp_file_write_size 64k;
          include    fastcgi_params;
     }
     
     # BigBlueButton landing page.
     location / {
          root   /var/www/bigbluebutton-default;
          index  index.html index.htm;
          expires 1m;
     }
     
     # Include specific rules for record and playback
     include /etc/bigbluebutton/nginx/*.nginx;
     
     # Redirect server error pages to the static page /50x.html
     #
     error_page   500 502 503 504  /50x.html;
     location = /50x.html {
          root   /var/www/nginx-default;
     }
}
